name: THK Analytics integration
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  integrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: List root files
        run: ls -la

      - name: Ensure thk zip exists
        run: |
          if [ ! -f thk-analytics-124.zip ]; then
            echo "thk-analytics-124.zip not found in repo root" && exit 1
          fi

      - name: Extract THK archive
        run: |
          mkdir -p thirdparty/thk-analytics
          unzip -q thk-analytics-124.zip -d thirdparty/thk-analytics-temp
          # Handle single top-level directory vs flat archive robustly
          shopt -s nullglob dotglob
          TEMP_CONTENTS=(thirdparty/thk-analytics-temp/*)
          if [ ${#TEMP_CONTENTS[@]} -eq 1 ] && [ -d "${TEMP_CONTENTS[0]}" ]; then
            # move nested contents (preserve subdirs)
            find "${TEMP_CONTENTS[0]}" -mindepth 1 -maxdepth 1 -exec mv -t thirdparty/thk-analytics/ {} + || true
          else
            # move top-level entries
            find thirdparty/thk-analytics-temp -mindepth 1 -maxdepth 1 -exec mv -t thirdparty/thk-analytics/ {} + || true
          fi
          shopt -u dotglob nullglob
          rm -rf thirdparty/thk-analytics-temp

      - name: Backup originals
        run: |
          mkdir -p thirdparty/thk-analytics-backups
          find thirdparty/thk-analytics -type f \( -name '*.php' -o -name '*.html' \) -exec bash -c 'f="$0"; dest="thirdparty/thk-analytics-backups/${f#thirdparty/thk-analytics/}"; mkdir -p "$(dirname "$dest")"; cp -a "$f" "$dest"' {} \;

      - name: Neutralize admin token checks
        run: |
          # Replace exact ADMIN_TOKEN occurrences (annotated) and common token checks
          find thirdparty/thk-analytics -type f -name '*.php' -print0 | xargs -0 sed -i -E "s/\\bADMIN_TOKEN\\b/true \/\\* ADMIN_TOKEN removed by integration \\\*\//g" || true
          find thirdparty/thk-analytics -type f -name '*.php' -print0 | xargs -0 sed -i -E "s/\\$_POST\\['token'\\][[:space:]]*!==[[:space:]]*ADMIN_TOKEN/true \/\\* token check removed \\\*\//g" || true

      - name: Remove Copyright lines
        run: |
          find thirdparty/thk-analytics -type f \( -name '*.html' -o -name '*.php' \) -print0 | xargs -0 sed -i -E '/Copyright/Id; /THK Analytics/Id; /Thought is free/Id; /WEB SERVICE BY DMM\\.com/Id' || true

      - name: Add TODO for mysql_* usage
        run: |
          grep -R --line-number "mysql_" thirdparty/thk-analytics || true
          find thirdparty/thk-analytics -type f -name '*.php' | while read -r file; do
            if grep -q "mysql_" "$file"; then
              # If file starts with <?php, insert a TODO comment after the opening tag; otherwise prepend a PHP open+comment block
              if head -n 1 "$file" | grep -q '^<?php'; then
                sed -i '1 a // TODO: mysql_* usage detected - please replace with PDO/mysqli' "$file" || true
              else
                { printf "<?php\n// TODO: mysql_* usage detected - please replace with PDO/mysqli\n"; cat "$file"; } > "$file.tmp" && mv "$file.tmp" "$file" || true
              fi
            fi
          done

      - name: Lint PHP files
        run: |
          set +e
          find thirdparty/thk-analytics -type f -name '*.php' -exec php -l {} \; || true

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add thirdparty/thk-analytics thirdparty/thk-analytics-backups || true
          git commit -m "Integrate THK Analytics: extract and apply basic patches" || echo "No changes to commit"
          git push origin HEAD:feature/integrate-thk-analytics-integrated || true

      - name: Output result
        run: |
          echo "Extraction & patches complete. Pushed to feature/integrate-thk-analytics-integrated"
